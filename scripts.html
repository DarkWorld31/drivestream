
<script>
$(function() {
     $('.modal').modal();
     console.log( "Fetching libraries..." );
     Materialize.toast("Fetching libraries...", 1000);
     //createLoader('#libraries');
     getLibraries();
     
     //google.script.run.withSuccessHandler(init).scanFolder();
    });
    
    function init(string) {
     console.log(string);
    }
    
    function getLibraries() {
    google.script.run.withSuccessHandler(showLibraries).getLibraries();
    }
    
    $('#authButton').click(function(){
     $('#newLibrary').modal('open');
     createLoader("#folders");
     google.script.run.withSuccessHandler(showFolders).listRootFolders();
     
    });
    
    function showFolders(things) {
     
    
     var list = $('#folders');
     list.empty();
     for (var i = 0; i < things.length; i++) {
      list.append(
      
       '<li><input type="checkbox" class="filled-in newLibrary" id="'+ things[i][1] +'" />' +
       '<label for="'+ things[i][1] +'">'+things[i][0]+'</label></li>'
      );
     }
    }
    
    $('#createLibrary').click(function(){
     var ids = $('input:checkbox:checked.newLibrary').map(function () {
      return this.id;
     }).get();
     
     var data = new Array;
     
     data[0] = $('#newLibraryName').val();
     data[1] = $('#newLibraryType').val();
     data[2] = ids;
         
     $('#newLibraryForm').trigger("reset");
     
     Materialize.toast("Creating library...");
     
     google.script.run.withSuccessHandler(createLibrarySuccess).withFailureHandler(createLibraryFailure).withUserObject(data).createLibrary(data);
     
     getLibraries();
     
     function createLibrarySuccess(id) {
     var toastElement = $('.toast').first()[0];
     var toastInstance = toastElement.M_Toast;
     toastInstance.remove();
     
      Materialize.toast(data[0] + ' was created!', 3000);
      getLibraries();
      console.log(id);
      google.script.run.scanLibrary(id);
      Materialize.toast('Scan of '+data[0] + ' has begun!', 3000);
     }
    });
    
    
    
    function createLibraryFailure(e) {
     Materialize.toast('Failed to create library: ' + e, 3000)
    }
    
    function showLibraries(things) {
     var list = $('#libraries');
     list.empty();
     for (var i = 1; i < things.length; i++) {
      list.append(
      
       ' <div class="col s4">'+
       '   <div class="card">'+
       '     <div class="card-content"'+
       '       <img src="https://picsum.photos/100/100">'+
       '       <span class="card-title">' + things[i][0]+'</span>'+
       '     </div>'+
      '      <div class="card-action">'+
       '       <a data-library-id="'+ things[i][3] +'" data-library-name="'+ things[i][0] +'" class="openLibrary">Open</a>'+
       '       <a data-library-id="'+ things[i][3] +'" data-library-name="'+ things[i][0] +'" class="refreshLibrary">Refresh</a>'+
      '      </div>'+
      '    </div>'+
       ' </div>'
      );
     }
    }
    
    
    
    function createLoader(element) {
     $(element).html(
      '<div class="preloader-wrapper active" style="margin:20px">' +
      '<div class="spinner-layer spinner-blue">'+
      '  <div class="circle-clipper left">'+
      '    <div class="circle"></div>'+
      '  </div><div class="gap-patch">'+
      '    <div class="circle"></div>'+
      '  </div><div class="circle-clipper right">'+
      '    <div class="circle"></div>'+
      '  </div>'+
      '</div>'
     );
    }
    
    function createLoaderInd(element) {
     $(element).html(
     '<div class="progress">' +
     '<div class="indeterminate"></div>' +
     '</div>'
     );
    }
    
    $( '#libraries' ).on( 'click', 'a.openLibrary', function () {
     var name = $(this).data("library-name");
     console.log(name);
     Materialize.toast("Opening " + name + "...",3000);
     google.script.run.withSuccessHandler(openLibrarySuccess).openLibrary($(this).data("library-id"));
     
     function openLibrarySuccess(files) {
     var list = $('.library');
     list.empty();
     console.log(files[4]);
     for (var i = 1; i < files.length; i++) {
     var image;
     console.log(files[i][9]);
     if (files[i][9] != "") {
      if (files[i][9].includes(".jpg")) { image = "https://image.tmdb.org/t/p/w154/" + files[i][9] } 
      else { image = files[i][9]; }
     } else {
      image = "https://via.placeholder.com/154x231";
      //google.script.run.withSuccessHandler(getThumbSuccess).getThumb(files[i][0]);
     }
     
      list.append(
       '<div class="col s4 m4">'+
     '    <div class="card horizontal media-card" id="'+files[i][0]+'">'+
     '      <div class="card-image">'+
     '        <img src="'+image+'" class="media-image">'+
     '      </div>'+
     '      <div class="card-stacked">'+
     '        <div class="card-content">'+
     '          <strong class="media-title">'+files[i][1]+'</strong>'+
     '            <p>Runs for: '+msToTime(files[i][2])+', Resolution: '+files[i][4]+'p</p>' +
     '        </div>'+
     '        <div class="card-action">'+
     '          <a class="dropdown-button" data-activates="dropdown_'+files[i][0]+'">Watch</a>'+
     '<ul id="dropdown_'+files[i][0]+'" class="dropdown-content">'+
     '    <li><a href="https://drive.google.com/file/d/'+files[i][0]+'/preview" target="_blank"><i class="material-icons">play_arrow</i>SD</a></li>'+
     '    <li><a class="media-hd" data-id="'+files[i][0]+'"><i class="material-icons">play_arrow</i>HD</a></li>'+
     '    <li class="divider"></li>'+
     '    <li><a href="https://drive.google.com/uc?export=download&id='+files[i][0]+'" target="_blank"><i class="material-icons">file_download</i>Download</a></li>'+
     '  </ul>' +
     '        </div>'+
     '      </div>'+
     '    </div>'+
     '  </div>'
      );
      
      enableDropdowns();     
      //movieAPIRequest(files[i][1],files[i][0]);
     }
     
     
     }
     
    });
    
     $( '#libraries' ).on( 'click', 'a.refreshLibrary', function () {
      var id = $(this).data('library-id');
      google.script.run.withSuccessHandler(refreshLibrarySuccess).refreshMetadata(id);
      Materialize.toast('Refreshing library...');
      createLoaderInd(this.closest('.card-action'));
     });
     
     function refreshLibrarySuccess() {
     }
     
     $( '#libraries' ).on( 'click', 'a.media-hd', function () {
      var id = $(this).data('id');
      google.script.run.withSuccessHandler(getHDSuccess).refreshMetadata(id);
     });
    
    function getThumbSuccess(data) {
     $('#' + data.id + ' .media-image').attr('src',data.thumb);
    }
    
   
   function getTitle(name) {
    name = name.replace('.',' ');
    var patt = /[^0-9](19|20)[0-9]{2}[^0-9]/;
    var match = patt.exec(name);
    if (match) {
    var name = name.substr(0,match.index);
    //console.log(name);
    
    }
    
    return name;
    
   }
   
  
       
    function movieAPIRequest(name,id) {
    var title = getTitle(name);
    console.log("Making request for " + title);
    
    var settings = {
    "async": true,
    "crossDomain": true,
    "url": "https://api.themoviedb.org/3/search/movie?include_adult=false&page=1&query="+title+"&language=en-US&api_key=",
    "method": "GET",
    "headers": {},
    "data": "{}"
    }
      
      setTimeout(function(){
      
      $.ajax(settings).done(function (response) {
      console.log("Loaded metadata for " + response.results[0].title);
      
      $('#' + id + ' .media-image').attr("src", "https://image.tmdb.org/t/p/w154" + response.results[0].poster_path);
      
      });
      
      }, 1000* Math.random());
    
    
    }
    
    
    function msToTime(duration) {
        var milliseconds = parseInt((duration%1000)/100)
            , seconds = parseInt((duration/1000)%60)
            , minutes = parseInt((duration/(1000*60))%60)
            , hours = parseInt((duration/(1000*60*60))%24);

        hours = (hours < 10) ? "0" + hours : hours;
        minutes = (minutes < 10) ? "0" + minutes : minutes;
        seconds = (seconds < 10) ? "0" + seconds : seconds;

        return hours + ":" + minutes + ":" + seconds;
    }
    
    
    function getRandomColor() {
    var colors = ["red","pink","purple","blue","teal","red","orange","grey","black"];
    
    //color = colors[Math.floor(Math.random() * colors.length)];
    color = "black";
    
    return color;
    }
    
    function enableDropdowns() {
     $('.dropdown-button').dropdown({
      inDuration: 300,
      outDuration: 225,
      constrainWidth: false, // Does not change width of dropdown to that of the activator
      hover: true, // Activate on hover
      gutter: 0, // Spacing from edge
      belowOrigin: false, // Displays dropdown below the button
      alignment: 'left', // Displays dropdown with edge aligned to the left of button
      stopPropagation: false // Stops event propagation
    
  });
  }
  
  function downloadFile(id) {
  
  google.script.run.withSuccessHandler(doDownload).getToken();
  
   function doDownload(accessToken) { 
    /* One-time setup (run once before other code)
 *   adds onreadystatechange to $.ajax options
 *   from https://gist.github.com/chrishow/3023092)
 *   success etc will still fire if provided
 */
    $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
        if ( options.onreadystatechange ) {
            var xhrFactory = options.xhr;
            options.xhr = function() {
                var xhr = xhrFactory.apply( this, arguments );
                function handler() {
                    options.onreadystatechange( xhr, jqXHR );
                }
                if ( xhr.addEventListener ) {
                    xhr.addEventListener( "readystatechange", handler, false );
                } else {
                    setTimeout( function() {
                        var internal = xhr.onreadystatechange;
                        if ( internal ) {
                            xhr.onreadystatechange = function() {
                                handler();
                                internal.apply( this, arguments ); 
                            };
                        }
                    }, 0 );
                }
                return xhr;
            };
        }
    });

    // ----- myReadyStateChange(): this will do my incremental processing -----
    var last_start = 0; // using global var for over-simplified example
    function myReadyStateChange(xhr /*, jqxhr */) {
        if(xhr.readyState >= 3 && xhr.responseText.length  > last_start) {
            var chunk = xhr.responseText.slice(last_start);
            alert('Got chunk: ' + chunk.length);
            console.log('Got chunk: ', chunk);
            $('div').append(chunk);
            last_start += chunk.length;
        }
    }

    // ----- call my url and process response incrementally -----
    last_start = 0;
    var fileId = '0B1aXJXlAP0eZV0EtX0ZCVTVxNUU';
    var accessToken = 'ya29.GlwyBRrB_Ur5E5L8MpjD_O5e6xiKw_rIkjlBDMeM5UA2AGZkK1Ne-2LA9_QVJnNsi1b3LdBML8h9e677y0H-PRuvxpe_JHAHFLBIJQ-NA1ngokj8SqvV9sfWYX3K4w';
    $.ajax({
        url: 'https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',
        headers: { 'Authorization' : 'OAuth '+accessToken },
        onreadystatechange: myReadyStateChange
    });
    
   }
   
   
  }
</script>